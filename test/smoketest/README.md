# Smoketest of RLA server

This smoketest has been tested against master commit 54a95d4.

For now, you'll need to install
[zerotest](https://github.com/jjyr/zerotest)
to run these tests, and/or generate new ones in the same way.

This is mainly tested with python3, but has been seen to work
on python2 also.

`pip install zerotest`

The current tests are based on the cvrs at
`test/e-1/arapahoe-regent-3-clear-CVR_Export.csv`
and the manifest at `test/e-1/arapahoe-manifest.csv`.

To run the smoketest, first cd to this directory.

Reset the `corla` database to be empty:

`dropdb corla; createdb -O corla corla`

and start up a fresh server.

Load the credentials for testing:

`psql -d corla -a -f ../corla-test-credentials.psql`

Run `./main.py` to upload the cvr and manifest files.

Run `psql -d corla -a -f tabulate.sql | diff tabulate.out -`
to check for differences in the tabulation.

Run `pytest server_test.py` to test some requests for information on the
cvr and manifest.

The `server_test.json` file has the raw data generated by the
`zerotest server` command, describing each request and the response.

## Updating tests
Prior to doing an update, perhaps first look at output of curl -I for each query below.
If there are failures, compare `test/corla-server_test.html` with the previous working commit.

Run the RLA tool server on port 8887, e.g. with an Eclipse Run
Configuration in which "Arguments" is set to
`src/main/resources/us/freeandfair/corla/proxiable.properties`.

In a different window, load a manifest and CVR with the --update option,
which runs them against port 8887:

`./main.py --update`

In a spare terminal, run this, where you can capture and watch the
queries which are being run:

```
zerotest server -p 8888 http://localhost:8887 -f server_test.json
```

Query the endpoints via this command:
```
bash -xv <<"EndOfInput" > curls.out 2>&1
 curl http://localhost:8888/ballot-manifest/county?3
 curl http://localhost:8888/ballot-manifest

 curl http://localhost:8888/contest
 curl http://localhost:8888/contest/county?3
 curl http://localhost:8888/contest/id/71
 curl http://localhost:8888/cvr/county?3
 curl http://localhost:8888/acvr/county?3
 curl http://localhost:8888/acvr
EndOfInput
```

Stop the `zerotest server` process, e.g. with Cntl-C.

Interrim test of captured queries:

`zerotest replay --ignore-all-headers server_test.json`

Generate raw test script which should work with existing database:

```
zerotest generate --ignore-all-headers server_test.json > server_test_raw.py 
sed 's,localhost:8887,localhost:8888,' server_test_raw.py > server_test_raw2.py
```

Stop and restart the server running on port 8888 as usual, and test it:

`pytest server_test_raw2.py`

Drop and rebuild the database in a new server to generate data in a possibly new
order:


`dropdb corla; createdb -O corla corla`

Load the credentials for testing:

`psql -d corla -a -f ../corla-test-credentials.psql`

Run `./main.py` to upload the cvr and manifest files.

Run `psql -d corla -a -f tabulate.sql | diff tabulate.out -`
to check for differences in the tabulation.

Run the new tests:

`pytest server_test_raw2.py > /tmp/server_test.out`

Fix any failing tests by e.g. changing

`matcher.match_responses(expect, real)`

to

`assert(abs(len(expect.body) - len(real.body)) < 10)`

and re-run until it works.  Save the working script in `server_test.py`

## Generating test data

To make an ACVR, download a CVR and modify it so that it is AUDITOR_GENERATED instead of UPLOADED.
Overvotes are allowed in ACVRs.